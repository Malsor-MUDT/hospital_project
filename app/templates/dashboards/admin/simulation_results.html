{% extends "dashboards/admin/base_admin.html" %}

{% block content %}

    <!-- Header with Back Button -->
    <div class="flex justify-between items-center">
        <div>
            <h1 class="text-2xl font-semibold text-teal-700">Simulation Results</h1>
            <p class="text-gray-600">Simulation ID: {{ simulation.simulation_id }}</p>
            <p class="text-sm text-gray-500">
                Run on: {{ simulation.simulation_date.strftime('%Y-%m-%d %H:%M') }}
            </p>
        </div>
        <div class="flex space-x-2">
            <a href="{{ url_for('admin.simulations') }}"
               class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded">
                <i class="fas fa-arrow-left mr-2"></i>Back
            </a>
        </div>
    </div>
    
    <!-- Simulation Summary -->
    <div class="bg-white shadow rounded-lg p-6">
        <h2 class="text-xl font-semibold text-teal-700 mb-4">Simulation Summary</h2>
        
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <div class="p-4 bg-teal-50 rounded-lg">
                <div class="text-sm text-teal-700">Total Devices</div>
                <div class="text-2xl font-bold">{{ results.device_count|default(0) }}</div>
            </div>
            
            <div class="p-4 bg-green-50 rounded-lg">
                <div class="text-sm text-green-700">Total Expected Revenue</div>
                <div class="text-2xl font-bold">
                    ${{ "%.2f"|format(results.total_revenue|default(0)) }}
                </div>
            </div>
            
            <div class="p-4 bg-blue-50 rounded-lg">
                <div class="text-sm text-blue-700">Total Expected Profit</div>
                <div class="text-2xl font-bold">
                    ${{ "%.2f"|format(results.total_profit|default(0)) }}
                </div>
            </div>
            
            <div class="p-4 bg-orange-50 rounded-lg">
                <div class="text-sm text-orange-700">Devices at Risk</div>
                <div class="text-2xl font-bold">
                    {% set at_risk = 0 %}
                    {% for device in results.devices|default([]) %}
                        {% if device.risk_level|default('') == 'high' %}
                            {% set at_risk = at_risk + 1 %}
                        {% endif %}
                    {% endfor %}
                    {{ at_risk }}
                </div>
            </div>
        </div>
        
        <!-- Device Results Table -->
        {% if results.devices %}
        <div class="overflow-x-auto">
            <table class="w-full text-sm">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="p-3 text-left">Device</th>
                        <th class="p-3 text-left">Expected Revenue</th>
                        <th class="p-3 text-left">Expected Profit</th>
                        <th class="p-3 text-left">Margin</th>
                        <th class="p-3 text-left">Risk Level</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200">
                    {% for device in results.devices %}
                    {% set margin = (device.gross_margin|default(0) * 100) %}
                    <tr class="hover:bg-gray-50">
                        <td class="p-3 font-medium">{{ device.device_name|default('Unknown Device') }}</td>
                        <td class="p-3">${{ "%.2f"|format(device.expected_revenue|default(0)) }}</td>
                        <td class="p-3">
                            <span class="{% if device.expected_profit|default(0) >= 0 %}text-green-700{% else %}text-red-700{% endif %}">
                                ${{ "%.2f"|format(device.expected_profit|default(0)) }}
                            </span>
                        </td>
                        <td class="p-3">
                            <span class="{% if margin >= 20 %}text-green-700{% elif margin >= 10 %}text-yellow-700{% else %}text-red-700{% endif %}">
                                {{ "%.1f"|format(margin) }}%
                            </span>
                        </td>
                        <td class="p-3">
                            {% set risk = device.risk_level|default('medium') %}
                            {% if risk == 'high' %}
                                <span class="px-2 py-1 text-xs font-medium bg-red-100 text-red-800 rounded">High</span>
                            {% elif risk == 'medium' %}
                                <span class="px-2 py-1 text-xs font-medium bg-yellow-100 text-yellow-800 rounded">Medium</span>
                            {% else %}
                                <span class="px-2 py-1 text-xs font-medium bg-green-100 text-green-800 rounded">Low</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-8 text-gray-500">
            No device data available for this simulation
        </div>
        {% endif %}
    </div>
    
    <!-- Recommendations -->
    {% if recommendations and recommendations|length > 0 %}
    <div class="bg-white shadow rounded-lg p-6">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-xl font-semibold text-teal-700">Price Recommendations</h2>
            <span class="px-3 py-1 bg-teal-100 text-teal-800 text-sm rounded-full">
                {{ recommendations|length }} suggestions
            </span>
        </div>
        
        {% for rec in recommendations %}
        <div class="mb-4 p-4 border rounded-lg {% if rec.urgency == 'high' %}bg-red-50 border-red-200{% else %}bg-yellow-50 border-yellow-200{% endif %}">
            <div class="flex justify-between items-start">
                <div>
                    <h3 class="font-medium text-gray-900">{{ rec.device_name|default('Unknown Device') }}</h3>
                    <div class="mt-1 text-sm text-gray-600">
                        Current: ${{ "%.2f"|format(rec.current_price|default(rec.get('current_price', 0))) }} 
                        ({{ "%.1f"|format(rec.current_margin|default(rec.get('current_margin', 0))) }}% margin)
                    </div>
                </div>
                <div class="text-right">
                    <div class="text-lg font-bold text-teal-700">
                        ${{ "%.2f"|format(rec.recommended_price|default(rec.get('recommended_price', 0))) }}
                    </div>
                    <div class="text-sm {% if rec.price_change_pct|default(rec.get('price_change_pct', 0)) > 0 %}text-red-600{% else %}text-green-600{% endif %}">
                        {{ "%+.1f"|format(rec.price_change_pct|default(rec.get('price_change_pct', 0))) }}%
                    </div>
                </div>
            </div>
            
            <div class="mt-2 text-sm">
                Target margin: {{ "%.1f"|format(rec.target_margin|default(rec.get('target_margin', 20))) }}%
                {% if rec.demand_change_pct %}
                    <div class="mt-1 text-gray-500">
                        Expected demand change: {{ "%+.1f"|format(rec.demand_change_pct|default(0)) }}%
                    </div>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}
    
    <!-- Simulation Parameters -->
    <div class="bg-white shadow rounded-lg p-6">
        <h2 class="text-xl font-semibold text-teal-700 mb-4">Simulation Parameters</h2>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                <h3 class="text-lg font-medium text-gray-800 mb-2">General Settings</h3>
                <div class="space-y-2 text-sm">
                    <div class="flex justify-between">
                        <span class="text-gray-600">Base Treatments per Month:</span>
                        <span class="font-medium">
                            {% if parameters.base_treatments %}
                                {{ parameters.base_treatments }}
                            {% elif parameters.base_treatments_per_month %}
                                {{ parameters.base_treatments_per_month }}
                            {% elif parameters.original_parameters and parameters.original_parameters.base_treatments_per_month %}
                                {{ parameters.original_parameters.base_treatments_per_month }}
                            {% else %}
                                N/A
                            {% endif %}
                        </span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Simulation Runs:</span>
                        <span class="font-medium">{{ parameters.simulation_runs|default('N/A') }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Simulation Date:</span>
                        <span class="font-medium">
                            {% if parameters.simulation_date %}
                                {{ parameters.simulation_date[:16]|replace('T', ' ') }}
                            {% else %}
                                {{ simulation.simulation_date.strftime('%Y-%m-%d %H:%M') }}
                            {% endif %}
                        </span>
                    </div>
                </div>
            </div>
            
            <!-- Quick Statistics - SIMPLIFIED -->
<div>
    <h3 class="text-lg font-medium text-gray-800 mb-2">Quick Statistics</h3>
    <div class="space-y-2 text-sm">
        <div class="flex justify-between">
            <span class="text-gray-600">Average Device Margin:</span>
            <span class="font-medium">
                {% if results.devices %}
                    {% set margins = [] %}
                    {% for device in results.devices %}
                        {% if device.gross_margin %}
                            {% set _ = margins.append(device.gross_margin * 100) %}
                        {% endif %}
                    {% endfor %}
                    {% if margins %}
                        {{ "%.1f"|format(margins|sum / margins|length) }}%
                    {% else %}
                        0.0%
                    {% endif %}
                {% else %}
                    0.0%
                {% endif %}
            </span>
        </div>
        <div class="flex justify-between">
            <span class="text-gray-600">Profitable Devices:</span>
            <span class="font-medium text-green-700">
                {% if results.devices %}
                    {% set profitable = namespace(count=0) %}
                    {% for device in results.devices %}
                        {% if device.expected_profit and device.expected_profit > 0 %}
                            {% set profitable.count = profitable.count + 1 %}
                        {% endif %}
                    {% endfor %}
                    {{ profitable.count }} of {{ results.devices|length }}
                {% else %}
                    0 of 0
                {% endif %}
            </span>
        </div>
        <div class="flex justify-between">
            <span class="text-gray-600">Loss-Making Devices:</span>
            <span class="font-medium text-red-700">
                {% if results.devices %}
                    {% set loss_making = namespace(count=0) %}
                    {% for device in results.devices %}
                        {% if device.expected_profit and device.expected_profit < 0 %}
                            {% set loss_making.count = loss_making.count + 1 %}
                        {% endif %}
                    {% endfor %}
                    {{ loss_making.count }} of {{ results.devices|length }}
                {% else %}
                    0 of 0
                {% endif %}
            </span>
        </div>
    </div>
</div>
        </div>
        
        <!-- Show additional parameters if they exist -->
        
    </div>
</div>
{% endblock %}